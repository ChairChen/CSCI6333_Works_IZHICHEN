# This workflow will do a clean installation of node dependencies, cache/restore them, build the source code and run tests across different versions of node
# For more information see: https://docs.github.com/en/actions/automating-builds-and-tests/building-and-testing-nodejs

name: React App Node.js CI/CD

on:
  push:
    branches: [ "main" ]
  workflow_dispatch:
  # pull_request:
  #   branches: [ "main" ]

# ---------------------------------------------------------
# 1. ADD THIS SECTION
# Needed to allow GitHub Actions to update your website
# ---------------------------------------------------------
# The default template only reads code. To host a website, the workflow needs "write" permission to upload your files to GitHub Pages.
permissions:
  contents: read
  pages: write
  id-token: write
  
# ---------------------------------------------------------
# 2. ADD THIS SECTION
# This block is a safety mechanism to prevent messy deployments if you push code multiple times quickly.
# ---------------------------------------------------------
concurrency:
  group: "pages"
  cancel-in-progress: true

jobs:
  build:
    runs-on: ubuntu-latest

    # ---------------------------------------------------------
    # 3. DELETE THIS 'STRATEGY' SECTION
    # We don't want to build the site 3 times.
    # ---------------------------------------------------------
    # This tells GitHub to run the job three times (once for each Node version) in parallel. You do not want to deploy your website three times simultaneously; it will cause conflicts. You only need to build it once using one stable Node version (e.g., version 20).
    # See supported Node.js release schedule at https://nodejs.org/en/about/releases/
    # strategy:
    #   matrix:
    #     node-version: [18.x, 20.x, 22.x]

    steps:
    - uses: actions/checkout@v4
    # - name: Use Node.js ${{ matrix.node-version }}
    - name: Set up Node
      uses: actions/setup-node@v4
      with:
        # node-version: ${{ matrix.node-version }}
        # Just pick one version (20 is standard)
        node-version: 20
        cache: 'npm'
        
    - run: npm ci
    
    # ---------------------------------------------------------
    # 4. MODIFY THESE STEPS
    # ---------------------------------------------------------
    # - run: npm run build --if-present
    - run: npm run build

    # ---------------------------------------------------------
    # 5. DELETE THIS 'npm test'
    # We don't want to build the site 3 times.
    # ---------------------------------------------------------
    # If your tests fail, the deployment will block.
    # - run: npm test

    # ---------------------------------------------------------
    # 6. ADD THIS STEP
    # This takes the 'build' folder and prepares it for GitHub Pages
    # ---------------------------------------------------------
    - name: Upload artifact
      uses: actions/upload-pages-artifact@v3
      with:
        path: ./build

  # ---------------------------------------------------------
  # 7. ADD THIS ENTIRE NEW JOB
  # This actually makes the website live
  # ---------------------------------------------------------
  deploy:
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    runs-on: ubuntu-latest
    needs: build
    steps:
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
